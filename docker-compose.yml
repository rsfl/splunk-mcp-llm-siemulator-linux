services:
  # -------------------- Splunk --------------------
  splunk:
    image: splunk/splunk:9.1.3               # â† pinned to last good build
    container_name: security-range-splunk
    hostname: security-range-splunk
    environment:
      SPLUNK_START_ARGS: --accept-license
      SPLUNK_PASSWORD: Password1             # change after first login
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN}  # pre-creates token
      SPLUNK_HEC_SSL: "false"
      SPLUNK_APPS_URL: /tmp/apps/mcp-ta_012.tgz,/tmp/apps/ta-ollama_015.tgz
    ports:
      - "8000:8000"
      - "8088:8088"
      - "8089:8089"                         # management port
      - "9997:9997"                         # receiving port for forwarders
      - "5514:514/udp"                       # syslog UDP port (changed to avoid conflict)
    volumes:
      - splunk_var:/opt/splunk/var
      - splunk_etc:/opt/splunk/etc
      - ./splunk-configs:/tmp/defaults
      - ./mcp-ta_012.tgz:/tmp/apps/mcp-ta_012.tgz
      - ./ta-ollama_015.tgz:/tmp/apps/ta-ollama_015.tgz
      - ./logs:/var/log/containers
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/services/collector/health"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s

  # -------------------- Ollama --------------------
  ollama:
    image: ollama/ollama:0.3.12
    container_name: security-range-ollama
    hostname: ollama-server
    depends_on:
      splunk:
        condition: service_healthy
    environment:
      OLLAMA_DEBUG: "1"
      OLLAMA_VERBOSE: "1"
      OLLAMA_ORIGINS: "*"
      RUST_LOG: "debug,ollama=trace"
      RUST_BACKTRACE: "full"
      OLLAMA_LOGS: "1"
      GIN_MODE: debug
      OLLAMA_LOG_LEVEL: DEBUG
      OLLAMA_LOG_PROMPT: "1"
      OLLAMA_LOG_REQUESTS: "1"
      OLLAMA_LOG_RESPONSES: "1"
      OLLAMA_ENABLE_LOGGING: "1"
    ports: ["11434:11434"]
    volumes:
      - ollama_models:/root/.ollama
      - ./logs:/var/log/ollama
    entrypoint: ["/bin/sh", "-c"]
    command: ["exec /bin/ollama serve > /var/log/ollama/ollama.log 2>&1"]

  # -------------------- MCP  ------------------
  ollama-mcp:
    image: node:20-slim
    container_name: security-range-ollama-mcp
    depends_on:
      ollama:
        condition: service_started
      splunk:
        condition: service_healthy
    environment:
      PORT: 3456
      OLLAMA_API: http://security-range-ollama:11434
      NODE_ENV: production
    command: ["/bin/bash", "-c", "mkdir -p /var/log && node /app/mcp-logger.js 2>/dev/null"]
    volumes:
      - ./logs:/var/log
      - ./mcp-logger.js:/app/mcp-logger.js:ro
    ports: ["3456:3456"]

  # -------------------- Splunk UF (Log Forwarder) --
  splunk-uf:
    image: splunk/universalforwarder:9.1.3
    container_name: security-range-splunk-uf
    hostname: splunk-uf
    environment:
      SPLUNK_START_ARGS: --accept-license
      SPLUNK_PASSWORD: Password1
      SPLUNK_STANDALONE_URL: security-range-splunk:9997
    volumes:
      - ./logs:/var/log/containers:ro
      - ./splunk-uf-configs:/tmp/defaults
    depends_on:
      splunk:
        condition: service_healthy

  # -------------------- Promptfoo -----------------
  promptfoo:
    image: ghcr.io/promptfoo/promptfoo:latest
    container_name: security-range-promptfoo
    network_mode: "host"
    volumes:
      - promptfoo_data:/home/promptfoo/.promptfoo
    depends_on: [ollama]

  # -------------------- OpenWebUI -----------------
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: security-range-openwebui
    environment:
      OLLAMA_BASE_URL: http://security-range-ollama:11434
      WEBUI_SECRET_KEY: your-secret-key   # ollama usually does NOT require authentication when running it locally
      LOG_LEVEL: DEBUG
      ENABLE_SIGNUP: "false"
      WEBUI_AUTH: "false"
    ports: ["3001:8080"]
    volumes:
      - openwebui_data:/app/backend/data
    depends_on: [ollama]
    restart: unless-stopped

# ---------- Named volumes ----------
volumes:
  ollama_models:
  splunk_var:
  splunk_etc:
  promptfoo_data:
  openwebui_data:

# ---------- Networks ----------
networks:
  default:
    driver: bridge
    enable_ipv6: false