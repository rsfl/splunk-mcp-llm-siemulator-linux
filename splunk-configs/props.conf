###############################################################################
## MCP JSON-RPC Sourcetypes (from TA-mcp-jsonrpc)
###############################################################################

[mcp:jsonrpc]
# JSON-RPC protocol messages from MCP servers
INDEXED_EXTRACTIONS = json
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = \"timestamp\"\s*:\s*\"
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%z
MAX_TIMESTAMP_LOOKAHEAD = 30
TRUNCATE = 100000
DATETIME_CONFIG = CURRENT

# Field extractions
FIELDALIAS-jsonrpc_version = jsonrpc AS mcp.jsonrpc_version
FIELDALIAS-method = method AS mcp.method
FIELDALIAS-id = id AS mcp.id
EVAL-mcp.message_type = case(isnotnull(method) AND isnull(id), "notification", isnotnull(method) AND isnotnull(id), "request", isnotnull(result), "response", isnotnull(error), "error", 1==1, "unknown")

# Tool call extractions
EVAL-mcp.tool_name = if(match(method, "tools/call"), 'params.name', null())
EVAL-mcp.tool_action = case(match(method, "tools/call"), "call", match(method, "tools/list"), "list", match(method, "initialize"), "initialize", 1==1, method)

# Security-relevant fields
EVAL-mcp.has_file_path = if(isnotnull('params.arguments.path') OR isnotnull('params.arguments.files'), "yes", "no")
EVAL-mcp.has_sensitive_operation = if(match(method, "write_file|push_files|delete|create_issue"), "yes", "no")

# GitHub operations
EVAL-mcp.github_owner = 'params.arguments.owner'
EVAL-mcp.github_repo = 'params.arguments.repo'
EVAL-mcp.github_action = case(match(method, "create_issue"), "create_issue", match(method, "push_files"), "push_files", match(method, "get_file"), "get_file", 1==1, null())

# Filesystem operations
EVAL-mcp.file_path = coalesce('params.arguments.path', 'params.arguments.files{}.path')
EVAL-mcp.file_operation = case(match('params.name', "read_file"), "read", match('params.name', "write_file"), "write", match('params.name', "delete_file"), "delete", match('params.name', "search_files"), "search", 1==1, null())

# Error tracking
EVAL-mcp.error_code = 'error.code'
EVAL-mcp.error_message = 'error.message'
EVAL-mcp.has_error = if(isnotnull(error), "yes", "no")

# Server info
EVAL-mcp.server_name = 'result.serverInfo.name'
EVAL-mcp.server_version = 'result.serverInfo.version'
EVAL-mcp.client_name = 'params.clientInfo.name'
EVAL-mcp.client_version = 'params.clientInfo.version'

# CIM Web data model mapping
EVAL-action = if(isnotnull(error), "blocked", "allowed")
EVAL-http_method = "POST"
EVAL-url = method
EVAL-uri_path = "/" . replace(method, "/", "/")
EVAL-status = if(isnotnull(error), "failure", "success")
EVAL-src = coalesce('params.clientInfo.name', "unknown_client")
EVAL-dest = coalesce('result.serverInfo.name', 'params.name', "unknown_server")
EVAL-http_user_agent = 'params.clientInfo.name' . "/" . 'params.clientInfo.version'
EVAL-vendor_product = "Anthropic MCP"
EVAL-app = coalesce('result.serverInfo.name', 'params.name', "mcp")

[mcp:stderr]
# MCP server stderr diagnostic logs
SHOULD_LINEMERGE = false
TIME_PREFIX = ^
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%Z
TRUNCATE = 10000

EXTRACT-log_level = \[(?<log_level>\w+)\]
EXTRACT-server_name = MCP server "(?<mcp_server_name>[^"]+)"
EXTRACT-stderr_message = Server stderr:\s*(?<mcp_stderr_message>.+)

[claude:mcp:debug]
# Claude Code debug logs (contains wrapped MCP server output)
SHOULD_LINEMERGE = false
TIME_PREFIX = ^
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%Z
MAX_TIMESTAMP_LOOKAHEAD = 30
TRUNCATE = 50000

EXTRACT-timestamp = ^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)
EXTRACT-log_level = \[(?<log_level>DEBUG|ERROR|INFO|WARN)\]
EXTRACT-mcp_server = MCP server "(?<mcp_server_name>[^"]+)"
EXTRACT-mcp_event = MCP server "[^"]+"\s+(?<mcp_event>Starting connection|Successfully connected|Connection failed|Received \w+ request)
EXTRACT-connection_time = connected.*in\s+(?<connection_time_ms>\d+)ms
EXTRACT-server_info_name = serverVersion.*name.*?:\s*"(?<server_name>[^"]+)"
EXTRACT-server_info_version = serverVersion.*version.*?:\s*"(?<server_version>[^"]+)"

[mcp:raw]
# Raw MCP logs (Docker/HEC ingestion)
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = ^\[?
TIME_FORMAT = %Y-%m-%d %H:%M:%S
DATETIME_CONFIG = CURRENT
TRUNCATE = 100000
KV_MODE = json

EXTRACT-mcp_timestamp = ^(?<mcp_timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})
EXTRACT-http_method = (?i)(GET|POST|PUT|DELETE|PATCH|OPTIONS)\s+
EXTRACT-endpoint = (?i)(?:GET|POST|PUT|DELETE|PATCH|OPTIONS)\s+(?<endpoint>[^\s]+)

[mcp:docker]
# MCP Docker container logs
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = ^
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%9N%Z
DATETIME_CONFIG = CURRENT
KV_MODE = json
TRUNCATE = 100000

[source::...mcp*.log]
sourcetype = mcp:jsonrpc

[source::...mcp*.json]
sourcetype = mcp:jsonrpc

[source::.../.claude/debug/*.txt]
sourcetype = claude:mcp:debug

###############################################################################
## Ollama/LLM Sourcetypes (from TA-ollama)
###############################################################################

[ollama:api]
# Structured JSON from Ollama API
KV_MODE = none
INDEXED_EXTRACTIONS = json
AUTO_KV_JSON = true
TIMESTAMP_FIELDS = time
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3Q%z
TRUNCATE = 200000
FIELDALIAS-ollama_api_model = model AS model_name

[ollama:server]
# Ollama server native logs - timestamp-based extraction
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TRUNCATE = 200000
AUTO_KV_JSON = true

# Time extraction - breaks on timestamp field in JSON logs
TIME_PREFIX = time=
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6N%z
MAX_TIMESTAMP_LOOKAHEAD = 50

SEDCMD-redact_email = s/([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})/[REDACTED_EMAIL]/g
SEDCMD-redact_key = s/(api[_-]?key|authorization|bearer)[=: ]+[^&\s]+/\1=[REDACTED]/gi

# Field extractions for structured logs
REPORT-ollama_web_fields = ollama_timestamp_extraction

# Extract key fields from structured logs
EVAL-code_source = if(match(_raw, "source=([^\s]+)"), replace(_raw, ".*source=([^\s]+).*", "\1"), null())
EVAL-log_level = if(match(_raw, "level=([^\s]+)"), replace(_raw, ".*level=([^\s]+).*", "\1"), null())
EVAL-log_msg = if(match(_raw, "msg=\"([^\"]+)\""), replace(_raw, ".*msg=\"([^\"]+)\".*", "\1"), null())

# CIM Web data model field mappings
FIELDALIAS-cim_web_dest = host AS dest
FIELDALIAS-cim_web_status = http_response_code AS status
FIELDALIAS-cim_web_method = http_method AS method

# CIM 5.0+ Web Datamodel Required Fields
EVAL-action = "allowed"
EVAL-app = "ollama"
EVAL-vendor_product = "Ollama API Server"
EVAL-product = "Ollama"
EVAL-category = "AI/ML API"
EVAL-response_time_ms = case(match(response_time, "(\d+)m(\d+(?:\.\d+)?)s"), tonumber(replace(response_time, "^(\d+)m.*", "\1"))*60000 + tonumber(replace(response_time, "^.*?(\d+(?:\.\d+)?)s$", "\1"))*1000, match(response_time, "µs$"), tonumber(replace(response_time, "µs", ""))/1000, match(response_time, "ms$"), tonumber(replace(response_time, "ms", "")), match(response_time, "s$"), tonumber(replace(response_time, "s", "")) * 1000, 1==1, 0)
EVAL-duration = round(response_time_ms/1000, 3)
EVAL-url = "http://".dest.":11434".uri_path
EVAL-bytes_in = 0
EVAL-bytes_out = 0
EVAL-http_user_agent = if(isnull(http_user_agent) OR http_user_agent="", "Ollama-Client", http_user_agent)
EVAL-http_referrer = ""
EVAL-site = "ollama_api"
EVAL-dest_port = 11434
EVAL-src_port = null()
EVAL-transport = "tcp"
EVAL-protocol = "http"
EVAL-web_method = http_method
EVAL-uri_query = if(match(uri_path, "\?(.+)"), replace(uri_path, "^[^\?]*\?(.+)$", "\1"), null())
EVAL-http_content_type = "application/json"
EVAL-vendor_action = action

[ollama:prompts]
# JSONL prompt/response data via HEC
KV_MODE = none
INDEXED_EXTRACTIONS = json
AUTO_KV_JSON = true
TIMESTAMP_FIELDS = time
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3Q%z
TRUNCATE = 200000
TRANSFORMS-redact_prompts = ollama_redact_prompts

[ollama:docker]
# Ollama Docker container logs - timestamp-based extraction
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TRUNCATE = 200000
AUTO_KV_JSON = true

# Time extraction - breaks on time= field in structured logs
TIME_PREFIX = time=
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6N%z
MAX_TIMESTAMP_LOOKAHEAD = 50

# Field extractions for structured logs
REPORT-ollama_web_fields = ollama_timestamp_extraction

# Extract key fields from structured logs
EVAL-code_source = if(match(_raw, "source=([^\s]+)"), replace(_raw, ".*source=([^\s]+).*", "\1"), null())
EVAL-log_level = if(match(_raw, "level=([^\s]+)"), replace(_raw, ".*level=([^\s]+).*", "\1"), null())
EVAL-log_msg = if(match(_raw, "msg=\"([^\"]+)\""), replace(_raw, ".*msg=\"([^\"]+)\".*", "\1"), null())

# CIM fields
EVAL-action = "allowed"
EVAL-app = "ollama"
EVAL-vendor_product = "Ollama API Server"
EVAL-product = "Ollama"
EVAL-category = "AI/ML API"

FIELDALIAS-cim_web_dest = host AS dest
FIELDALIAS-cim_web_status = http_response_code AS status
FIELDALIAS-cim_web_method = http_method AS method
