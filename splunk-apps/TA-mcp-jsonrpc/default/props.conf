##
## Splunk Technology Add-on for Model Context Protocol (MCP) JSON-RPC
## props.conf
##

[mcp:jsonrpc]
# JSON-RPC protocol messages from MCP servers
INDEXED_EXTRACTIONS = json
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = \"timestamp\"\s*:\s*\"
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%z
MAX_TIMESTAMP_LOOKAHEAD = 30
TRUNCATE = 100000
# Use jsonrpc field as timestamp fallback if timestamp not present
# Default to event indexing time if no timestamp in event
DATETIME_CONFIG = CURRENT

# Field extractions
FIELDALIAS-jsonrpc_version = jsonrpc AS mcp.jsonrpc_version
FIELDALIAS-method = method AS mcp.method
FIELDALIAS-id = id AS mcp.id
EVAL-mcp.message_type = case(isnotnull(method) AND isnull(id), "notification", isnotnull(method) AND isnotnull(id), "request", isnotnull(result), "response", isnotnull(error), "error", 1==1, "unknown")

# Tool call extractions
EVAL-mcp.tool_name = if(match(method, "tools/call"), 'params.name', null())
EVAL-mcp.tool_action = case(match(method, "tools/call"), "call", match(method, "tools/list"), "list", match(method, "initialize"), "initialize", 1==1, method)

# Security-relevant fields
EVAL-mcp.has_file_path = if(isnotnull('params.arguments.path') OR isnotnull('params.arguments.files'), "yes", "no")
EVAL-mcp.has_sensitive_operation = if(match(method, "write_file|push_files|delete|create_issue"), "yes", "no")

# GitHub operations
EVAL-mcp.github_owner = 'params.arguments.owner'
EVAL-mcp.github_repo = 'params.arguments.repo'
EVAL-mcp.github_action = case(match(method, "create_issue"), "create_issue", match(method, "push_files"), "push_files", match(method, "get_file"), "get_file", 1==1, null())

# Filesystem operations
EVAL-mcp.file_path = coalesce('params.arguments.path', 'params.arguments.files{}.path')
EVAL-mcp.file_operation = case(match('params.name', "read_file"), "read", match('params.name', "write_file"), "write", match('params.name', "delete_file"), "delete", match('params.name', "search_files"), "search", 1==1, null())

# Error tracking
EVAL-mcp.error_code = 'error.code'
EVAL-mcp.error_message = 'error.message'
EVAL-mcp.has_error = if(isnotnull(error), "yes", "no")

# Server info
EVAL-mcp.server_name = 'result.serverInfo.name'
EVAL-mcp.server_version = 'result.serverInfo.version'
EVAL-mcp.client_name = 'params.clientInfo.name'
EVAL-mcp.client_version = 'params.clientInfo.version'

# CIM Web data model mapping
EVAL-action = if(isnotnull(error), "blocked", "allowed")
EVAL-http_method = "POST"
EVAL-url = method
EVAL-uri_path = "/" . replace(method, "/", "/")
EVAL-status = if(isnotnull(error), "failure", "success")
EVAL-src = coalesce('params.clientInfo.name', "unknown_client")
EVAL-dest = coalesce('result.serverInfo.name', 'params.name', "unknown_server")
EVAL-http_user_agent = 'params.clientInfo.name' . "/" . 'params.clientInfo.version'
EVAL-vendor_product = "Anthropic MCP"
EVAL-app = coalesce('result.serverInfo.name', 'params.name', "mcp")

[mcp:stderr]
# MCP server stderr diagnostic logs (less useful, but included)
SHOULD_LINEMERGE = false
TIME_PREFIX = ^
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%Z
TRUNCATE = 10000

# Extract log level if present
EXTRACT-log_level = \[(?<log_level>\w+)\]
EXTRACT-server_name = MCP server "(?<mcp_server_name>[^"]+)"
EXTRACT-stderr_message = Server stderr:\s*(?<mcp_stderr_message>.+)

[claude:mcp:debug]
# Claude Code debug logs (contains wrapped MCP server output)
SHOULD_LINEMERGE = false
TIME_PREFIX = ^
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%Z
MAX_TIMESTAMP_LOOKAHEAD = 30
TRUNCATE = 50000

# Extract fields from Claude Code debug format
EXTRACT-timestamp = ^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)
EXTRACT-log_level = \[(?<log_level>DEBUG|ERROR|INFO|WARN)\]
EXTRACT-mcp_server = MCP server "(?<mcp_server_name>[^"]+)"
EXTRACT-mcp_event = MCP server "[^"]+"\s+(?<mcp_event>Starting connection|Successfully connected|Connection failed|Received \w+ request)
EXTRACT-connection_time = connected.*in\s+(?<connection_time_ms>\d+)ms
EXTRACT-server_info_name = serverVersion.*name.*?:\s*"(?<server_name>[^"]+)"
EXTRACT-server_info_version = serverVersion.*version.*?:\s*"(?<server_version>[^"]+)"

[source::...mcp*.log]
sourcetype = mcp:jsonrpc

[source::...mcp*.json]
sourcetype = mcp:jsonrpc

[source::.../.claude/debug/*.txt]
sourcetype = claude:mcp:debug
