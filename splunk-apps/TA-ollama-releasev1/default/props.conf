# -------- ollama:api (structured JSON from modular input)
[ollama:api]
KV_MODE = none
INDEXED_EXTRACTIONS = json
AUTO_KV_JSON = true
TIMESTAMP_FIELDS = time
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3Q%z
TRUNCATE = 200000
FIELDALIAS-ollama_api_model = model AS model_name

# -------- ollama:server (native logs; plain text or mixed JSON lines)
[ollama:server]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TRUNCATE = 200000
AUTO_KV_JSON = true

# Time extraction - handles both GIN and standard Ollama log formats
TIME_PREFIX = ^(?:\[GIN\]\s+|time=)
MAX_TIMESTAMP_LOOKAHEAD = 50

SEDCMD-redact_email = s/([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})/[REDACTED_EMAIL]/g
SEDCMD-redact_key   = s/(api[_-]?key|authorization|bearer)[=: ]+[^&\s]+/\1=[REDACTED]/gi

# CIM Web Datamodel Field Mappings for CIM 5.0+ compliance
# Use REPORT for more reliable field extraction that works with datamodels
REPORT-ollama_web_fields = ollama_web_extraction

# Trim whitespace from extracted fields (GIN logs use variable-width padding)
EVAL-src = trim(src)
EVAL-response_time = trim(response_time)

# Extract Go source file location from structured logs (e.g., source=server.go:1332)
# This avoids conflict with Splunk's built-in 'source' metadata field
EVAL-code_source = if(match(_raw, "source=([^\s]+)"), replace(_raw, ".*source=([^\s]+).*", "\1"), null())

# Map host to dest for CIM compatibility
FIELDALIAS-cim_web_dest = host AS dest
FIELDALIAS-cim_web_status = http_response_code AS status
FIELDALIAS-cim_web_method = http_method AS method

# CIM 5.0+ Web Datamodel Required Fields
# Post-process extracted fields for CIM compliance
EVAL-action = "allowed"
EVAL-app = "ollama"
EVAL-vendor_product = "Ollama API Server"
EVAL-product = "Ollama"
EVAL-category = "AI/ML API"
EVAL-response_time_ms = case(match(response_time, "(\d+)m(\d+(?:\.\d+)?)s"), tonumber(replace(response_time, "^(\d+)m.*", "\1"))*60000 + tonumber(replace(response_time, "^.*?(\d+(?:\.\d+)?)s$", "\1"))*1000, match(response_time, "µs$"), tonumber(replace(response_time, "µs", ""))/1000, match(response_time, "ms$"), tonumber(replace(response_time, "ms", "")), match(response_time, "s$"), tonumber(replace(response_time, "s", "")) * 1000, 1==1, 0)
EVAL-duration = round(response_time_ms/1000, 3)
EVAL-url = "http://".dest.":11434".uri_path

# Additional CIM Web fields for full compliance
EVAL-bytes_in = 0
EVAL-bytes_out = 0
EVAL-http_user_agent = if(isnull(http_user_agent) OR http_user_agent="", "Ollama-Client", http_user_agent)
EVAL-http_referrer = ""
EVAL-site = "ollama_api"
EVAL-dest_port = 11434
EVAL-src_port = null()
EVAL-transport = "tcp"
EVAL-protocol = "http"
EVAL-web_method = http_method
EVAL-uri_query = if(match(uri_path, "\?(.+)"), replace(uri_path, "^[^\?]*\?(.+)$", "\1"), null())

# Additional useful fields
EVAL-http_content_type = "application/json"
EVAL-vendor_action = action

# -------- ollama:prompts (JSONL sent via HEC)
[ollama:prompts]
KV_MODE = none
INDEXED_EXTRACTIONS = json
AUTO_KV_JSON = true
TIMESTAMP_FIELDS = time
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3Q%z
TRUNCATE = 200000
TRANSFORMS-redact_prompts = ollama_redact_prompts
